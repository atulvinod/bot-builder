name: Build Containers

on:
    workflow_dispatch:
    release:
        types: [published]

jobs:
    build:
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: Checkout Branch
              uses: actions/checkout@v3

            - name: Github Reference
              run: |
                echo "Ref: " -> ${{ github.ref }}

            - name: Login to Dockerhub
              uses: docker/login-action@v1
              with:
                username: ${{secrets.DOCKER_USERNAME}}
                password: ${{secrets.DOCKER_PASSWORD}}
            
            - name: Build environment files
              env:
                CHAT_SERVICE_ENV: ${{secrets.CHAT_SERVICE_ENV}}
                EMBED_SERVICE_ENV: ${{secrets.EMBED_SERVICE_ENV}}
                FIREBASE_SERVICE_CONFIG: ${{secrets.FIREBASE_SERVICE_CONFIG}}
              run: |
                touch ./chat-service/.env
                touch ./embed-service/.env
                touch ./embed-service/firebase_service_account_config.json
                echo $CHAT_SERVICE_ENV | base64 --decode > ./chat-service/.env
                echo $EMBED_SERVICE_ENV | base64 --decode > ./embed-service/.env
                echo $FIREBASE_SERVICE_CONFIG | base64 --decode ./embed-service/firebase_service_account_config.json
              
            
            - name: Docker Build Embedding Service
              uses: docker/build-push-action@v2
              with:
                context: './embed-service'
                file: 'Dockerfile'
                push: true
                tags: 'atulvinod1911/botbuilder-embed-service:${{github.ref}}'

            - name: Docker Build Chat Service
              uses: docker/build-push-action@v2
              with:
                context: './chat-service'
                file: 'Dockerfile'
                push: true
                tags: 'atulvinod1911/botbuilder-chat-service:${{github.ref}}'

